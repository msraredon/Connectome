---
title: "Processing Time"
author: "Micha Sam Brickman Raredon"
date: "`r Sys.Date()`"

vignette: >
  %\VignetteIndexEntry{Connectome Basic Workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}

---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Processing time is affected by both the number of cell parcellations and total cell number.

## Load dependencies
```{r message=F, warning=F}
library(Seurat)
library(SeuratData)
library(Connectome)
library(ggplot2)
library(cowplot)

```

## Load, set identity slot, and pre-process the data
Here, we run *Connectome* on the cross-platform Pancreas data distributed by SeuratData:
```{r message=F, warning=F}
InstallData('panc8')
data('panc8')
table(Idents(panc8))
Idents(panc8) <- panc8[['celltype']]
table(Idents(panc8))

# Normalize the data
panc8 <- NormalizeData(panc8)

# Set up genes to use in next section
connectome.genes <- union(Connectome::ncomms8866_human$Ligand.ApprovedSymbol,Connectome::ncomms8866_human$Receptor.ApprovedSymbol)
genes <- connectome.genes[connectome.genes %in% rownames(panc8)]

```

## Processing time vs. cell number and parcellation number (w/out statistical analysis)

``` {r  message=F, warning=F, results = 'hide'}
max.cells.per.ident = seq(100,4000,500)
comp.time.basic <- data.frame()
for (j in 2:13){ 
  panc8.sub.1 <- subset(panc8,idents = names(table(Idents(panc8)))[1:j])
  temp <- data.frame()
for (i in 1:length(max.cells.per.ident)){
  panc8.sub <- subset(panc8.sub.1,downsample = max.cells.per.ident[i])
  panc8.sub <- ScaleData(panc8.sub,features = genes)
  t1 <- Sys.time()
  panc8.con <- CreateConnectome(panc8.sub,species = 'human',min.cells.per.ident = 75,p.values = F,calculate.DOR = F)
  t2 <- Sys.time()
  
  cell.num <- ncol(panc8.sub)
  parcell.num <- length(table(Idents(panc8.sub)))
  
  temp[i,"parcellations"] <- parcell.num
  temp[i,"cells"] <- cell.num
  temp[i,'max.cells.per.ident'] <- max.cells.per.ident[i]
  temp[i,"comp.time"] <- t2-t1
}
 comp.time.basic <- rbind(comp.time.basic,temp)
}
save(comp.time.basic,file = 'comp.time.basic.Robj')
```


## Processing time vs. cell number and parcellation number (w/ statistical analysis)

``` {r  message=F, warning=F, results = 'hide'}
max.cells.per.ident = seq(100,4000,500)

comp.time.stat <- data.frame()
for (j in 9:9){ #length(num.parcellations)
  panc8.sub.1 <- subset(panc8,idents = names(table(Idents(panc8)))[1:j])
  temp <- data.frame()
for (i in 1:length(max.cells.per.ident)){
  panc8.sub <- subset(panc8.sub.1,downsample = max.cells.per.ident[i])
  panc8.sub <- ScaleData(panc8.sub,features = genes)
  t1 <- proc.time()
  panc8.con <- CreateConnectome(panc8.sub,species = 'human',min.cells.per.ident = 75,p.values = T,calculate.DOR = F)
  t2 <- proc.time()
  
  cell.num <- ncol(panc8.sub)
  parcell.num <- length(table(Idents(panc8.sub)))
  
  temp[i,"parcellations"] <- parcell.num
  temp[i,"cells"] <- cell.num
  temp[i,'max.cells.per.ident'] <- max.cells.per.ident[i]
  temp[i,"comp.time"] <- (t2-t1)[[3]]
}
 comp.time.stat <- rbind(comp.time.stat,temp)
}
save(comp.time.stat,file = 'comp.time.stat.Robj')
```

## Plotting
``` {r  message=F, warning=F, results = 'hide',fig.height=2,fig.width=6}
p1 <- ggplot(subset(comp.time.basic,parcellations <9),aes(x = max.cells.per.ident,y = comp.time, colour = as.factor(parcellations),group = as.factor(parcellations))) + geom_point() + geom_line() +
  labs(colour = "Number of Parcellations")+
  ylab('Seconds') + xlab('Max Cells Per Ident')+
  ggtitle('Connectome runtime without statistical analysis')

p2 <- ggplot(subset(comp.time.stat,parcellations <9),aes(x = max.cells.per.ident,y = comp.time, colour = as.factor(parcellations),group = as.factor(parcellations))) + geom_point() + geom_line() +
  labs(colour = "Number of Parcellations")+
    ylab('Seconds') + xlab('Max Cells Per Ident')+
  ggtitle('Connectome runtime with Wilcoxon Rank Sum Test')

plot_grid(p1,p2)

```